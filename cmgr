#!/bin/bash
# cmgr - Claude Desktop Manager
# Manages multiple isolated instances of Claude Desktop

set -euo pipefail

# Load libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/dependencies.sh"
source "${SCRIPT_DIR}/lib/sandbox.sh"
source "${SCRIPT_DIR}/lib/installer.sh"
source "${SCRIPT_DIR}/lib/instance.sh"
source "${SCRIPT_DIR}/lib/config.sh"
source "${SCRIPT_DIR}/lib/desktop.sh"
source "${SCRIPT_DIR}/lib/help.sh"

# Check for basic dependencies
if ! check_dependencies; then
    echo "Required dependencies are missing. Please install them as indicated above."
    exit 1
fi

# Global variables - handle sudo properly
if [ "$(id -u)" -eq 0 ] && [ -n "${SUDO_USER:-}" ]; then
    # Running as root with sudo
    ORIGINAL_USER="${SUDO_USER}"
    ORIGINAL_HOME=$(eval echo ~${SUDO_USER})
    CMGR_HOME="${ORIGINAL_HOME}/.cmgr"
    SANDBOX_BASE="${ORIGINAL_HOME}/sandboxes"
    
    # Make sure we don't use root's home
    export HOME="${ORIGINAL_HOME}"
else
    # Running as regular user
    CMGR_HOME="${HOME}/.cmgr"
    SANDBOX_BASE="${HOME}/sandboxes"
fi

CMGR_CACHE="${CMGR_HOME}/cache"
CMGR_REGISTRY="${CMGR_HOME}/registry.json"

# Ensure basic directories exist
mkdir -p "${CMGR_HOME}" "${CMGR_CACHE}" "${SANDBOX_BASE}" "${CMGR_HOME}/logs"

# Initialize registry if it doesn't exist
if [ ! -f "${CMGR_REGISTRY}" ]; then
    echo '{"instances": {}}' > "${CMGR_REGISTRY}"
fi

# Fix ownership if running as root
if [ "$(id -u)" -eq 0 ] && [ -n "${SUDO_USER:-}" ]; then
    chown -R "${SUDO_USER}:$(id -gn "${SUDO_USER}")" "${CMGR_HOME}" "${SANDBOX_BASE}"
fi

# Command handlers
cmd_create() {
    local instance_name="$1"
    shift
    create_instance "$instance_name" "$@"
}

cmd_list() {
    list_instances
}

cmd_start() {
    local instance_name="$1"
    start_instance "$instance_name"
}

cmd_stop() {
    local instance_name="$1"
    stop_instance "$instance_name"
}

cmd_remove() {
    local instance_name="$1"
    remove_instance "$instance_name"
}

cmd_config() {
    local instance_name="$1"
    shift
    configure_instance "$instance_name" "$@"
}

cmd_alias() {
    local instance_name="$1"
    local alias_name="${2:-}"
    create_alias "$instance_name" "$alias_name"
}

cmd_desktop() {
    local instance_name="$1"
    create_desktop_shortcut "$instance_name"
}

cmd_mcp() {
    local instance_name="$1"
    shift
    configure_mcp "$instance_name" "$@"
}

cmd_execute() {
    local instance_name="$1"
    shift
    execute_claude_command "$instance_name" "$@"
}

cmd_help() {
    show_help
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        cmd_help
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        create)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_create "$@"
            ;;
        list)
            cmd_list
            ;;
        start)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_start "$@"
            ;;
        stop)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_stop "$@"
            ;;
        remove)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_remove "$@"
            ;;
        config)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_config "$@"
            ;;
        alias)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_alias "$@"
            ;;
        desktop)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_desktop "$@"
            ;;
        mcp)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_mcp "$@"
            ;;
        execute)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_execute "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            echo "Error: Unknown command '$command'"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"