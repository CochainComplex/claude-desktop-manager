#!/bin/bash
# cmgr - Claude Desktop Manager
# Manages multiple isolated instances of Claude Desktop

set -euo pipefail

# Load libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/dependencies.sh"
source "${SCRIPT_DIR}/lib/sandbox.sh"
source "${SCRIPT_DIR}/lib/installer.sh"
source "${SCRIPT_DIR}/lib/instance.sh"
source "${SCRIPT_DIR}/lib/config.sh"
source "${SCRIPT_DIR}/lib/desktop.sh"

# Check for basic dependencies
if ! check_dependencies; then
    echo "Required dependencies are missing. Please install them as indicated above."
    exit 1
fi

# Global variables
CMGR_HOME="${HOME}/.cmgr"
CMGR_CACHE="${CMGR_HOME}/cache"
CMGR_REGISTRY="${CMGR_HOME}/registry.json"
SANDBOX_BASE="${HOME}/sandboxes"

# Ensure basic directories exist
mkdir -p "${CMGR_HOME}" "${CMGR_CACHE}" "${SANDBOX_BASE}"

# Initialize registry if it doesn't exist
if [ ! -f "${CMGR_REGISTRY}" ]; then
    echo '{"instances": {}}' > "${CMGR_REGISTRY}"
fi

# Command handlers
cmd_create() {
    local instance_name="$1"
    shift
    create_instance "$instance_name" "$@"
}

cmd_list() {
    list_instances
}

cmd_start() {
    local instance_name="$1"
    start_instance "$instance_name"
}

cmd_stop() {
    local instance_name="$1"
    stop_instance "$instance_name"
}

cmd_remove() {
    local instance_name="$1"
    remove_instance "$instance_name"
}

cmd_config() {
    local instance_name="$1"
    shift
    configure_instance "$instance_name" "$@"
}

cmd_alias() {
    local instance_name="$1"
    local alias_name="${2:-}"
    create_alias "$instance_name" "$alias_name"
}

cmd_desktop() {
    local instance_name="$1"
    create_desktop_shortcut "$instance_name"
}

cmd_mcp() {
    local instance_name="$1"
    shift
    configure_mcp "$instance_name" "$@"
}

cmd_help() {
    cat <<EOF
Claude Desktop Manager (cmgr) - Manage multiple Claude Desktop instances

Usage: cmgr COMMAND [OPTIONS]

Commands:
  create <name> [options]   Create a new Claude instance
  list                      List all instances
  start <name>              Start a specific instance
  stop <name>               Stop a running instance
  remove <name>             Remove an instance
  config <name> [options]   Configure instance settings
  alias <name> [alias]      Create command alias for instance
  desktop <name>            Create desktop shortcut
  mcp <name> [options]      Configure MCP settings
  help                      Show this help message

Examples:
  cmgr create work          Create a new instance named "work"
  cmgr start work           Start the work instance
  cmgr alias work           Create an alias for the work instance

For more information, see the README.md file.
EOF
}

# Main command dispatcher
main() {
    if [ $# -eq 0 ]; then
        cmd_help
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        create)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_create "$@"
            ;;
        list)
            cmd_list
            ;;
        start)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_start "$@"
            ;;
        stop)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_stop "$@"
            ;;
        remove)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_remove "$@"
            ;;
        config)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_config "$@"
            ;;
        alias)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_alias "$@"
            ;;
        desktop)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_desktop "$@"
            ;;
        mcp)
            if [ $# -lt 1 ]; then
                echo "Error: Missing instance name"
                cmd_help
                exit 1
            fi
            cmd_mcp "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            echo "Error: Unknown command '$command'"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"